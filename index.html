<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Square Border Maker</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lilita+One&display=swap" rel="stylesheet" />
  <style>
    :root {
      --g1: #feda75;
      --g2: #fa7e1e;
      --g3: #d62976;
      --g4: #962fbf;
      --g5: #4f5bd5;
      --bg: linear-gradient(135deg, var(--g1) 0%, var(--g2) 25%, var(--g3) 50%, var(--g4) 75%, var(--g5) 100%);
      --grad: linear-gradient(90deg, var(--g1), var(--g2), var(--g3));
      --hover: #d62976;
      --txt: #fff;
      --rad: 1rem;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
      --glass: rgba(255, 255, 255, 0.32);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', 'Noto Sans JP', sans-serif;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: var(--bg);
      padding: 1rem;
    }
    .card {
      width: 100%;
      max-width: 560px;
      padding: 2rem 2.2rem;
      border-radius: var(--rad);
      background: var(--glass);
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
    }
    @media (max-width: 600px) {
      .card {
        max-width: 100%;
        padding: 1.3rem;
      }
    }
    h1 {
      font-family: 'Lilita One', cursive;
      font-size: 2rem;
      text-align: center;
      margin-bottom: 1.4rem;
      color: var(--txt);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
    }
    .custom-file {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.8rem;
      width: 100%;
      padding: 3.4rem 1rem;
      border-radius: calc(var(--rad) - 0.25rem);
      color: var(--txt);
      border: 3px dashed rgba(255, 255, 255, 0.75);
      background: rgba(255, 255, 255, 0.25);
      cursor: pointer;
      font-size: 1.05rem;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
      transition: 0.35s;
    }
    .custom-file:hover,
    .custom-file.dragover {
      border-color: var(--hover);
      background: rgba(255, 255, 255, 0.45);
      color: var(--hover);
    }
    input[type='file'] {
      display: none;
    }
    .btn {
      display: block;
      margin-top: 1.6rem;
      width: 100%;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      color: #fff;
      border-radius: 9999px;
      background: var(--grad);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
    }
    .btn.disabled {
      pointer-events: none;
      opacity: 0.55;
    }
    canvas,
    #preview {
      display: none;
      margin-top: 1.4rem;
      width: 100%;
      border: 3px solid rgba(255, 255, 255, 0.8);
      border-radius: calc(var(--rad) - 0.25rem);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    }
    .progress {
      margin-top: 1.1rem;
      font-size: 0.9rem;
      color: #fff;
      text-align: center;
      min-height: 1.4em;
    }
    .progress-wrapper {
      margin: 0.6rem auto 0;
      height: 14px;
      background: rgba(255, 255, 255, 0.45);
      border-radius: 9999px;
      overflow: hidden;
      display: none;
      width: 80%;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      background: var(--grad);
      transition: width 0.1s linear;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ç”»åƒã‚’ã‚¹ã‚¯ã‚¨ã‚¢åŒ–</h1>
    <label for="picker" class="custom-file" id="droparea">
      <span class="icon">ğŸ“âœ¨</span>
      <span>ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—<br />ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ</span>
    </label>
    <input type="file" id="picker" accept="image/*" multiple />
    <canvas id="c"></canvas>
    <img id="preview" alt="preview" />
    <a id="download" class="btn disabled">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    <div class="progress" id="status">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
    <div class="progress-wrapper" id="progressWrapper"><div class="progress-bar" id="bar"></div></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const picker = $("picker"),
      drop = $("droparea"),
      dl = $("download"),
      status = $("status"),
      wrap = $("progressWrapper"),
      bar = $("bar"),
      canvas = $("c"),
      ctx = canvas.getContext("2d"),
      preview = $("preview"),
      isM = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    const BORDER = 60,
      MAX = 2000;

    const enable = (u, f) => {
        dl.href = u;
        dl.download = f;
        dl.classList.remove("disabled");
      },
      disable = () => {
        dl.removeAttribute("href");
        dl.classList.add("disabled");
      };

    const load = (f) =>
      new Promise((ok, no) => {
        const i = new Image();
        i.onload = () => ok(i);
        i.onerror = no;
        i.src = URL.createObjectURL(f);
      });

    function square(i) {
      let { width: w, height: h } = i;
      if (Math.max(w, h) > MAX) {
        const s = MAX / Math.max(w, h);
        w = Math.round(w * s);
        h = Math.round(h * s);
      }
      const S = Math.max(w, h) + BORDER * 2;
      canvas.width = canvas.height = S;
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, S, S);
      ctx.drawImage(i, (S - w) / 2, (S - h) / 2, w, h);
      return new Promise((r) => canvas.toBlob(r, "image/png"));
    }

    async function run(files) {
      if (!files.length) return;
      disable();
      status.textContent = "å‡¦ç†ä¸­â€¦";
      bar.style.width = "0%";
      wrap.style.display = files.length > 1 ? "block" : "none";
      canvas.style.display = "none";
      preview.style.display = "none";

      if (files.length === 1) {
        try {
          const img = await load(files[0]);
          const blob = await square(img);
          const url = URL.createObjectURL(blob);

          if (isM) {
            preview.src = url;
            preview.style.display = "block";
            status.textContent = "ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚";
          } else {
            canvas.style.display = "block";
            enable(url, "square.png");
            status.textContent = "å®Œäº†ï¼PNG ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™";
          }
        } catch (e) {
          console.error(e);
          status.textContent = "ã‚¨ãƒ©ãƒ¼";
        }
        return;
      }

      const zip = new JSZip();
